# Non-SDS Hazard Assessment Workflow

## Overview

Many workplace hazards **do not have Safety Data Sheets (SDS)** because they are **generated by processes** rather than being supplied as chemical products.

**Examples**: Welding fumes, wood dust, silica dust, diesel exhaust, flour dust, metalworking fluid mist

HSE explicitly states: *"Some substances arise from processes and have no safety data sheet, including fume from welding or soldering, mist from metalworking, dust from quarrying, and gases from silage."*

This document describes how Safety Copilot handles these non-SDS hazards.

---

## Database Schema

### `process_generated_hazards` Table

Stores library of common process-generated hazards with:

- **Hazard identification**: Name, category, process type
- **Physical properties**: Form (fume/dust/mist/gas), particle size
- **Equivalent H-codes**: GHS codes that would apply if substance had SDS (for risk scoring)
- **EH40 WELs**: Workplace exposure limits where applicable
- **Special classifications**: Carcinogen, respiratory sensitiser, asthmagen, skin sensitiser
- **Severity scoring**: Pre-calculated severity for inhalation, skin/eye, ingestion
- **Health effects**: Long-term and acute effects
- **HSE guidance links**: Direct links to official HSE guidance

### `process_hazard_control_measures` Table

Stores pre-populated control measures for each hazard:

- **Control hierarchy**: Elimination → Substitution → Engineering → Administrative → PPE
- **Control effectiveness**: High/Medium/Low
- **COSHH section mapping**: Operational controls, ventilation, PPE, monitoring, health surveillance
- **Implementation notes**: Practical guidance for each control

---

## Workflow: Non-SDS Hazard Assessment

### Step 1: User Identifies Process (Not Chemical)

**UI**: When creating a COSHH assessment, user selects:
- **SDS Upload** (for chemical products with SDS)
- **Process Hazard** (for process-generated hazards WITHOUT SDS)

### Step 2: Search Process Hazard Library

**UI**: User enters process description:
- "Welding stainless steel"
- "Cutting hardwood"
- "Grinding concrete"
- "Operating diesel forklift indoors"
- "Mixing flour"

**Backend**: System searches `process_generated_hazards` table:
```typescript
const hazards = await searchProcessHazards("welding stainless");
// Returns: [{ hazard_name: "Stainless steel welding fume", ... }]
```

### Step 3: Select Hazard from Library

**UI**: Show list of matching hazards with summary:
```
Stainless steel welding fume (Welding fumes)
  WEL: 5 mg/m³ (8-hr TWA)
  [Carcinogen, Respiratory Sensitiser]
  ⚠️ Contains chromium VI - Group 1 carcinogen
```

User selects the hazard.

### Step 4: Auto-Populate Hazard Data

**Backend**: Fetch full hazard details + control measures:
```typescript
const hazard = await getProcessHazardByName("Stainless steel welding fume");
const controls = await getProcessHazardControlSummary(hazard.id);
```

**Auto-populated sections**:

#### Section 3: Hazards Identified
```
- Carcinogen (H350) - Chromium VI in fume
- Respiratory sensitiser (H334) - Can cause occupational asthma
- Skin sensitiser (H317) - Chrome ulcers
- STOT-RE (H372) - Lung damage

Physical form: Fume (respirable <10 µm)
WEL: 5 mg/m³ (8-hr TWA, inhalable)

Health effects:
  Long-term: Lung cancer, occupational asthma, chrome ulcers
  Acute: Respiratory irritation, skin burns
  Target organs: Lungs, respiratory system, skin, nasal passages
```

#### Section 5: Operational Controls
```
- Local Exhaust Ventilation (LEV) - fume extraction at source
- General ventilation - ensure adequate air changes
- Limit duration of welding tasks
```

#### Section 6: Ventilation
```
- On-torch extraction or fixed extraction hood
- Must capture fume before it reaches breathing zone
- General ventilation not sufficient on its own
```

#### Section 8: Personal Protective Equipment
```
- Respiratory Protective Equipment (RPE) - FFP3 mask or powered air respirator
- Face-fit testing required
- RPE must be adequate for fume type (stainless steel)
```

#### Section 10: First Aid
```
(None specific - general workplace first aid)
```

#### Section 11: Fire Response
```
(None specific - welding hot work permits required)
```

#### Section 12: Spill Response
```
(Not applicable - fume/dust hazard)
```

#### Section 13: Storage & Handling
```
(Not applicable - generated in-situ)
```

#### Section 14: Monitoring & Health Surveillance
```
Air monitoring:
- Personal air sampling to measure fume exposure
- Verify controls keep exposure below WEL (5 mg/m³)

Health surveillance (MANDATORY):
- Annual respiratory questionnaire
- Lung function tests
- Required for regular welders (>30 days/year)
```

### Step 5: Task Assignment (Same as SDS Workflow)

User creates **Process Steps** → assigns **Tasks** → assigns this hazard to specific tasks:

```typescript
const task = {
  task_type: "Welding",
  task_name: "Welding stainless steel chassis",
  duration: "2 hours/day",
  frequency: "Daily",
  environment: "Workshop with LEV",
  existing_controls: ["On-torch fume extraction", "General ventilation"],
  chemicals_involved: [
    {
      type: "process_hazard", // NOT "sds_chemical"
      hazard_id: hazard.id,
      hazard_name: "Stainless steel welding fume",
      h_codes: ["H350", "H334", "H317", "H372"], // From equivalent_h_codes
    }
  ]
};
```

### Step 6: Risk Scoring (Identical to SDS Workflow)

**Severity** from `process_generated_hazards` table (NOT from H-phrases table):
```typescript
const severity = getProcessHazardSeverity(hazard);
// Returns: { inhalation: 5, ingestion: 0, skinEye: 3 }
```

**Likelihood** from ChatGPT (task context):
```typescript
const likelihood = await assessTaskLikelihood(task, severity);
// Returns: { inhalation_likelihood: 4, ingestion_likelihood: 0, skinEye_likelihood: 2 }
```

**Risk Score** = Severity × Likelihood:
```typescript
const riskScore = {
  inhalation: 5 × 4 = 20 (Very High)
  ingestion: 0 × 0 = 0 (N/A)
  skinEye: 3 × 2 = 6 (Low)
};

Overall Risk: Very High (due to inhalation risk)
```

---

## Comparison: SDS vs Non-SDS Workflow

| Aspect | SDS Chemical | Process Hazard |
|--------|-------------|----------------|
| **Data source** | Upload SDS PDF → Extract with GPT Vision | Search process hazard library |
| **H-codes** | From SDS Section 2 → Query `h_phrases` table | Pre-assigned in `process_generated_hazards.equivalent_h_codes` |
| **P-codes** | From SDS Section 2 → Query `p_phrases` table | N/A - use `process_hazard_control_measures` instead |
| **Control measures** | Auto-populate from P-phrases | Auto-populate from `process_hazard_control_measures` |
| **Severity** | Max severity from `h_phrases` table | Pre-calculated in `process_generated_hazards` |
| **WEL** | Query `eh40_exposure_limits` by CAS number | Stored in `process_generated_hazards.wel_8hr_twa_mgm3` |
| **Task assignment** | Same | Same |
| **Risk scoring** | Same (severity × likelihood) | Same |
| **Health surveillance** | Check EH40 + H-phrases | Check `requires_health_surveillance()` |

---

## AI Prompts for Non-SDS Hazards

### Prompt: Suggest Process Hazards

```typescript
const prompt = `The user is creating a COSHH assessment and has described the following work process:

"${userInput}"

Based on this description, identify which process-generated hazards (if any) are likely to be present.

Process hazards are substances WITHOUT Safety Data Sheets that are generated by work processes.

Common examples:
- Welding fumes (from MIG, TIG, arc welding)
- Wood dust (from cutting, sanding wood)
- Silica dust (from cutting, grinding stone/concrete)
- Metalworking fluid mist (from machining)
- Diesel exhaust (from forklifts, vehicles indoors)
- Flour dust (from mixing, sieving flour)

Return JSON array of suggested hazard categories:
[
  {
    "hazard_category": "Welding fumes",
    "confidence": "high",
    "reason": "User mentioned 'welding stainless steel chassis'"
  }
]`;
```

### Prompt: Likelihood Assessment (Same for SDS and Non-SDS)

```typescript
const prompt = `You are assessing occupational exposure risk for a specific task.

TASK DETAILS:
- Task type: ${task.task_type}
- Duration: ${task.duration}
- Frequency: ${task.frequency}
- Environment: ${task.environment}
- Existing controls: ${task.existing_controls?.join(', ')}

HAZARD: ${hazard.hazard_name}
- Type: Process-generated hazard (${hazard.hazard_category})
- Physical form: ${hazard.physical_form}
- WEL: ${hazard.wel_8hr_twa_mgm3} mg/m³

SEVERITY SCORES (pre-calculated):
- Inhalation: ${severity.inhalation}/5
- Ingestion: ${severity.ingestion}/5
- Skin/eye: ${severity.skinEye}/5

Based on the task context and existing controls, rate the LIKELIHOOD (0-5) of exposure via each route...`;
```

---

## Handling Mixed SDS + Non-SDS Assessments

Some processes involve **both SDS chemicals AND process hazards**.

**Example**: Spray painting

- **SDS chemical**: Paint (toluene, xylene)
- **Process hazard**: Spray mist/overspray

**Workflow**:
1. User uploads SDS for paint → extracts H-codes, P-codes
2. User adds process hazard "Spray mist" from library
3. Task assignment: "Spray painting" task involves BOTH:
   ```typescript
   chemicals_involved: [
     {
       type: "sds_chemical",
       name: "Acme Paint",
       cas_number: "...",
       h_codes: ["H225", "H304", "H336"],
     },
     {
       type: "process_hazard",
       hazard_id: "spray-mist-id",
       hazard_name: "Spray mist",
       h_codes: ["H335"], // From equivalent_h_codes
     }
   ]
   ```
4. Risk scoring: Calculate combined severity (max of all H-codes)
5. Control measures: Merge P-phrases + process control measures

---

## Database Seeding

### Initial Seed (Completed)

`/supabase/seed_process_hazards.sql` contains ~20 most common process hazards:

- Welding fumes (general, stainless steel, solder)
- Wood dust (hardwood, softwood, MDF)
- Silica dust (RCS, sandblasting, concrete, granite)
- Metalworking fluids
- Diesel exhaust (DEEE, carbon monoxide)
- Flour/grain dust
- Rubber fumes
- Stone dust

Each hazard includes:
- Full hazard data (severity, WEL, classifications)
- 3-6 control measures across hierarchy

### Future Expansion

Add more niche hazards as needed:
- Latex aerosol (healthcare)
- Textile dust (cotton, hemp)
- Organic dusts (hay, compost)
- Silage gases (nitrogen dioxide)
- Asphalt fumes
- Bitumen fumes
- Lead fumes (torch cutting old painted metal)

---

## UI Components Needed

### 1. Hazard Source Selector
```
┌─────────────────────────────────────┐
│ Add Hazard to Assessment            │
│                                     │
│ ○ Upload SDS (chemical product)     │
│ ○ Select Process Hazard (no SDS)    │
└─────────────────────────────────────┘
```

### 2. Process Hazard Search
```
┌─────────────────────────────────────┐
│ Search Process Hazards              │
│ ┌─────────────────────────────────┐ │
│ │ Describe the process...         │ │
│ └─────────────────────────────────┘ │
│                                     │
│ Suggestions:                        │
│ ✓ Welding stainless steel           │
│   - Carcinogen, Resp. Sens.         │
│   - WEL: 5 mg/m³                    │
│                                     │
│ ✓ Hardwood dust                     │
│   - Carcinogen, Asthma hazard       │
│   - WEL: 3 mg/m³                    │
└─────────────────────────────────────┘
```

### 3. Process Hazard Details (Modal)
```
┌─────────────────────────────────────────────┐
│ Stainless Steel Welding Fume               │
│                                             │
│ Category: Welding fumes                     │
│ Physical form: Fume (respirable <10 µm)     │
│                                             │
│ ⚠️ Classifications:                          │
│ • Carcinogen (H350) - Chromium VI           │
│ • Respiratory Sensitiser (H334)             │
│ • Skin Sensitiser (H317)                    │
│                                             │
│ WEL: 5 mg/m³ (8-hr TWA, inhalable)          │
│                                             │
│ Health Effects:                             │
│ Long-term: Lung cancer, occupational asthma │
│ Acute: Respiratory irritation               │
│                                             │
│ [View Full Guidance] [Add to Assessment]    │
└─────────────────────────────────────────────┘
```

### 4. Task Assignment (Combined SDS + Process)
```
┌─────────────────────────────────────────────┐
│ Task: Welding stainless steel chassis       │
│                                             │
│ Hazards involved:                           │
│ ☑ Stainless steel welding fume (Process)    │
│ ☑ Acetone (SDS) - for degreasing            │
│                                             │
│ Duration: 2 hours/day                       │
│ Frequency: Daily                            │
│ Environment: Workshop with LEV              │
│                                             │
│ Existing controls:                          │
│ • On-torch fume extraction                  │
│ • General ventilation                       │
│ • FFP3 respirator                           │
└─────────────────────────────────────────────┘
```

---

## Implementation Checklist

- [x] Database schema (`process_generated_hazards.sql`)
- [x] Seed data with ~20 common hazards (`seed_process_hazards.sql`)
- [x] TypeScript types (`process-hazards.ts`)
- [x] Database query functions (`db/process-hazards.ts`)
- [ ] Update task types to support both SDS + process hazards
- [ ] Update risk scoring to handle process hazards
- [ ] UI: Hazard source selector (SDS vs Process)
- [ ] UI: Process hazard search and selection
- [ ] UI: Process hazard details modal
- [ ] AI prompt: Suggest process hazards from task description
- [ ] Integration: Merge SDS + process control measures
- [ ] Testing: End-to-end workflow with mixed hazards

---

## Next Steps

1. **Update `task` type** in `/src/types/process-steps.ts`:
   ```typescript
   export interface TaskChemical {
     type: 'sds_chemical' | 'process_hazard';

     // For SDS chemicals
     name?: string;
     cas_number?: string;

     // For process hazards
     hazard_id?: string;
     hazard_name?: string;

     // Common
     h_codes: string[];
     quantity?: string;
     concentration?: string;
   }
   ```

2. **Update risk scoring** in `/src/lib/risk-scoring.ts`:
   ```typescript
   export async function calculateTaskSeverity(chemicals: TaskChemical[]) {
     let maxInhalation = 0;
     let maxIngestion = 0;
     let maxSkinEye = 0;

     for (const chem of chemicals) {
       if (chem.type === 'sds_chemical') {
         // Query h_phrases table
         const severities = await calculateExposureSeverities(chem.h_codes);
         maxInhalation = Math.max(maxInhalation, severities.inhalation);
         maxIngestion = Math.max(maxIngestion, severities.ingestion);
         maxSkinEye = Math.max(maxSkinEye, severities.skinEye);
       } else if (chem.type === 'process_hazard') {
         // Query process_generated_hazards table
         const hazard = await getProcessHazardById(chem.hazard_id!);
         if (hazard) {
           maxInhalation = Math.max(maxInhalation, hazard.inhalation_severity);
           maxIngestion = Math.max(maxIngestion, hazard.ingestion_severity);
           maxSkinEye = Math.max(maxSkinEye, hazard.skin_eye_severity);
         }
       }
     }

     return { inhalation: maxInhalation, ingestion: maxIngestion, skinEye: maxSkinEye };
   }
   ```

3. **Create UI components** for process hazard selection

4. **Test complete workflow** with mixed SDS + process hazards
